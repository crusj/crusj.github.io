---
title: 抽奖算法
date: 2018-10-20 14:29:29
tags: php 抽奖
category: php
---

通过程序进行抽奖比较常见，算法可能比较多的实现，以下通过一种比较简单取随机数的方法进行抽奖算法的实现
<!-- more -->
## 实现功能

该代码可以实现任意权重的抽奖(包含权重为小数),如果权重为小数,对所有权重以10其最小权重的小数位数的幂次方放大,例如0.1所有权重放大10倍

## 实现原理

* 1.计算所有奖项的权重和
* 2.将奖项按照权重的大小降序排序
* 3.取１到权重和的随机数
* 4.迭代奖项将随机数与每个迭代项的权重进行比较，如果小于该迭代项的权重则返回该奖项，权重和减去该迭代项
 
## 代码如下

```php
<?php
class Lottery {
    //奖项=>权重
    private $a_sets;
    //初始化，奖项对应的各项权重
    public function __construct(array &$a_sets){
        //如果中奖权重中有小数，则找出其中最小的数，对所有中奖权重进行基于其进行10倍数进行放大使所有权重都为整数
        //找出最小的数
        $a_weights = array_values($a_sets);
        $i_min = $a_weights[0];

        //找出最小数
        (function()use(&$a_weights,&$i_min){
            foreach($a_weights as $i_item):
                if($i_item < $i_min) $i_min = $i_item;
            endforeach;
        })();
        
        //判断小数位数
        $a_tmp = explode(".",$i_min);
        $i_size = count($a_tmp) == 2 ? strlen($a_tmp[1]): 0;

        //放大所有权重为整数
        if($i_size > 0):
            array_walk($a_sets,function(&$i_item)use(&$i_size){
                $i_item = intval($i_item *  pow(10,$i_size));
            });
        endif;
        //按照权重降序排序
        krsort($a_sets);
        $this->a_sets = $a_sets;
    }

    //抽奖
    public function draw(){
        //总的权重
        $i_totalWeight = array_sum($this->a_sets);
        foreach($this->a_sets as $prize => $i_weight):
            $i_rand = mt_rand(1,$i_totalWeight);
            if($i_rand <= $i_weight):
                return $prize;
            endif;
            $i_totalWeight -= $i_weight;
        endforeach;
    }
}
$a_testSets = [
    4 => 101,
    3 => 70,
    2 => 50,
    1 => 0.1   
];
$o_lottery = new Lottery($a_testSets);
$i_prize = $o_lottery->draw();//抽奖
```